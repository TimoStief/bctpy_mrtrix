{% extends "base.html" %}

{% block title %}BCT Analysis - Home{% endblock %}

{% block content %}
<div class="container">
    <div class="row gy-4">
        <!-- Column 1: Input Settings -->
        <div class="col-lg-4">
            <div class="card feature-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Input Settings</h5>
                </div>
                <div class="card-body">
                    <!-- Input Directory Selector -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Input Directory</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="inputDir" placeholder="/path/to/data (e.g., /Users/karl/work/github/bctpy_mrtrix/Test_matrizen)">
                            <button class="btn btn-primary" type="button" id="browseInputBtn">
                                <i class="fas fa-check me-1"></i>Validate
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Directory should contain: ses-1, ses-2, ses-3, ses-4 folders with .npy files
                        </small>
                        <div id="inputError" class="alert alert-danger d-none mt-2" role="alert"></div>
                    </div>

                    <!-- Session Detection -->
                    <div id="sessionInfo" class="alert alert-info d-none" role="alert">
                        <h6 class="mb-2"><i class="fas fa-check-circle me-2"></i>Sessions Found:</h6>
                        <ul class="mb-0" id="sessionList"></ul>
                    </div>

                    <!-- Output Directory -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Output Directory</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="outputDir" placeholder="Optional: leave empty for auto (input_dir/bct_output)">
                            <button class="btn btn-secondary" type="button" id="browseOutputBtn">
                                <i class="fas fa-check me-1"></i>Validate
                            </button>
                        </div>
                        <small class="text-muted">Optional: leave empty for default location</small>
                        <div id="outputError" class="alert alert-danger d-none mt-2" role="alert"></div>
                    </div>

                    <!-- Analysis Type -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Analysis Type</label>
                        <select class="form-select" id="analysisType">
                            <option value="full">Full Analysis (All Metrics)</option>
                            <option value="analyze">Matrix Analysis Only</option>
                        </select>
                    </div>

                    <!-- Start Button -->
                    <button class="btn btn-success btn-lg w-100" id="startAnalysisBtn" disabled>
                        <i class="fas fa-play me-2"></i>Start Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Column 2: Terminal Output -->
        <div class="col-lg-8">
            <div class="card feature-card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>Analysis Terminal</h5>
                </div>
                <div class="card-body p-0">
                    <div id="terminalOutput" class="terminal-output">
                        <div class="terminal-welcome">
                            <p>Welcome to BCT Analysis Web Interface</p>
                            <p>Select input directory and click "Start Analysis" to begin</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        <span id="logStatus">Waiting for input...</span>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row gy-4 mt-3" id="resultsSection" style="display: none;">
        <div class="col-lg-12">
            <div class="card feature-card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Analysis Results</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="totalMatrices">0</div>
                                <div class="stat-label">Matrices Processed</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="sessionCount">0</div>
                                <div class="stat-label">Sessions Found</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-value" id="subjectCount">0</div>
                                <div class="stat-label">Subjects</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <a class="btn btn-outline-success btn-lg w-100" id="downloadResultsBtn" href="#">
                                <i class="fas fa-download me-2"></i>Download Results
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let logUpdateInterval = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('browseInputBtn').addEventListener('click', () => pickFolder('input'));
    document.getElementById('browseOutputBtn').addEventListener('click', () => pickFolder('output'));
    document.getElementById('startAnalysisBtn').addEventListener('click', startAnalysis);
}

}
async function pickFolder(type) {
    const inputElem = type === 'input' ? document.getElementById('inputDir') : document.getElementById('outputDir');
    const errorElem = type === 'input' ? document.getElementById('inputError') : document.getElementById('outputError');
    const path = inputElem.value.trim();
    
    errorElem.classList.add('d-none');
    
    if (!path) {
        errorElem.textContent = 'Please enter a folder path';
        errorElem.classList.remove('d-none');
        return;
    }
    
    try {
        const response = await fetch('/api/validate-path', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        });
        
        const data = await response.json();
        
        if (data.success) {
            inputElem.value = data.path;
            if (type === 'input') {
                await checkSessions(data.path);
            }
            updateStartButtonState();
        } else {
            errorElem.textContent = data.error || 'Invalid path';
            errorElem.classList.remove('d-none');
        }
    } catch (error) {
        console.error('Error validating path:', error);
        errorElem.textContent = 'Error validating path: ' + error.message;
        errorElem.classList.remove('d-none');
    }

async function checkSessions(path) {
    try {
        const response = await fetch('/api/check-sessions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path })
        });
        
        const data = await response.json();
        const sessionInfo = document.getElementById('sessionInfo');
        const sessionList = document.getElementById('sessionList');
        
        if (data.has_sessions) {
            sessionList.innerHTML = data.sessions
                .map(s => `<li>${s.name}: ${s.files} file(s)</li>`)
                .join('');
            sessionInfo.classList.remove('d-none');
        } else {
            sessionInfo.classList.add('d-none');
        }
    } catch (error) {
        console.error('Error checking sessions:', error);
    }
}

function updateStartButtonState() {
    const inputDir = document.getElementById('inputDir').value.trim();
    const startBtn = document.getElementById('startAnalysisBtn');
    startBtn.disabled = !inputDir;
}

async function startAnalysis() {
    const inputDir = document.getElementById('inputDir').value.trim();
    const outputDir = document.getElementById('outputDir').value.trim();
    const analysisType = document.getElementById('analysisType').value;
    
    if (!inputDir) {
        alert('Please select an input directory');
        return;
    }
    
    // Clear terminal
    document.getElementById('terminalOutput').innerHTML = '';
    document.getElementById('startAnalysisBtn').disabled = true;
    
    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                input_dir: inputDir,
                output_dir: outputDir,
                analysis_type: analysisType
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Start polling for logs
            startLogUpdate();
            
            // Wait a bit then show results
            setTimeout(() => {
                showResults(data.summary);
            }, 2000);
        } else {
            appendTerminalOutput(`❌ Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Analysis error:', error);
        appendTerminalOutput(`❌ Error: ${error.message}`);
    } finally {
        document.getElementById('startAnalysisBtn').disabled = false;
    }
}

function startLogUpdate() {
    if (logUpdateInterval) clearInterval(logUpdateInterval);
    
    const updateLogs = async () => {
        try {
            const response = await fetch('/api/logs');
            const data = await response.json();
            
            const terminal = document.getElementById('terminalOutput');
            terminal.innerHTML = `<pre>${escapeHtml(data.logs)}</pre>`;
            terminal.scrollTop = terminal.scrollHeight;
            
            document.getElementById('logStatus').textContent = `${data.lines} log lines`;
        } catch (error) {
            console.error('Error updating logs:', error);
        }
    };
    
    updateLogs();
    logUpdateInterval = setInterval(updateLogs, 500);
}

function appendTerminalOutput(message) {
    const terminal = document.getElementById('terminalOutput');
    const pre = terminal.querySelector('pre');
    if (!pre) {
        terminal.innerHTML = '<pre></pre>';
    }
    terminal.querySelector('pre').textContent += message + '\n';
    terminal.scrollTop = terminal.scrollHeight;
}

function showResults(summary) {
    const resultsSection = document.getElementById('resultsSection');
    
    if (summary && summary.total_matrices > 0) {
        document.getElementById('totalMatrices').textContent = summary.total_matrices;
        document.getElementById('sessionCount').textContent = summary.sessions_processed.length;
        document.getElementById('subjectCount').textContent = summary.subjects.length;
        
        resultsSection.style.display = 'block';
        
        // Setup download button
        const outputDir = document.getElementById('outputDir').value;
        document.getElementById('downloadResultsBtn').href = 
            `/api/download/bct_analysis_results.xlsx?output_dir=${encodeURIComponent(outputDir)}`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
